name: Publish Spitestack CLI

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish (e.g. 0.1.0-alpha.5)"
        required: true
        type: string
      tag:
        description: "npm dist-tag (e.g. alpha)"
        required: false
        default: "alpha"
        type: string
      publish_wrapper:
        description: "Publish the JS wrapper package"
        required: false
        default: true
        type: boolean

permissions:
  contents: read
  id-token: write

jobs:
  publish-platforms:
    name: Publish ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    environment: release
    env:
      NPM_CONFIG_PROVENANCE: "true"
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            platform: darwin-arm64
            binary: spitestack
          - os: macos-12
            platform: darwin-x64
            binary: spitestack
          - os: ubuntu-latest
            platform: linux-x64-gnu
            binary: spitestack
          - os: windows-latest
            platform: win32-x64-msvc
            binary: spitestack.exe

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Debug npm/oidc
        shell: bash
        run: |
          echo "node: $(node --version)"
          echo "npm: $(npm --version)"
          if [[ -n "${ACTIONS_ID_TOKEN_REQUEST_URL:-}" ]]; then
            echo "oidc: available"
          else
            echo "oidc: missing"
          fi

      - uses: dtolnay/rust-toolchain@stable

      - name: Update versions
        shell: bash
        run: |
          node <<'NODE'
          const fs = require('fs');
          const version = '${{ inputs.version }}';
          const baseDir = 'packages/spitestack-cli/npm';
          const dirs = fs.readdirSync(baseDir).filter((d) => !d.startsWith('.'));
          const paths = [
            'packages/spitestack-cli/package.json',
            ...dirs.map((d) => `${baseDir}/${d}/package.json`),
          ];

          for (const p of paths) {
            const data = JSON.parse(fs.readFileSync(p, 'utf8'));
            data.version = version;
            if (data.optionalDependencies) {
              for (const k of Object.keys(data.optionalDependencies)) {
                data.optionalDependencies[k] = version;
              }
            }
            fs.writeFileSync(p, JSON.stringify(data, null, 2) + '\n');
          }
          NODE

      - name: Build CLI
        shell: bash
        run: cargo build -p spitestack-cli --release

      - name: Package binary
        shell: bash
        run: |
          dest_dir="packages/spitestack-cli/npm/${{ matrix.platform }}"
          src_bin="target/release/${{ matrix.binary }}"
          dest_bin="${dest_dir}/${{ matrix.binary }}"
          cp "$src_bin" "$dest_bin"
          if [[ "${{ matrix.platform }}" != win32-* ]]; then
            chmod +x "$dest_bin"
          fi

      - name: Publish platform package
        shell: bash
        run: |
          cd "packages/spitestack-cli/npm/${{ matrix.platform }}"
          npm publish --access public --tag "${{ inputs.tag }}" --provenance

  publish-wrapper:
    name: Publish wrapper
    runs-on: ubuntu-latest
    needs: publish-platforms
    if: ${{ inputs.publish_wrapper }}
    environment: release
    env:
      NPM_CONFIG_PROVENANCE: "true"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Debug npm/oidc
        shell: bash
        run: |
          echo "node: $(node --version)"
          echo "npm: $(npm --version)"
          if [[ -n "${ACTIONS_ID_TOKEN_REQUEST_URL:-}" ]]; then
            echo "oidc: available"
          else
            echo "oidc: missing"
          fi

      - name: Update versions
        shell: bash
        run: |
          node <<'NODE'
          const fs = require('fs');
          const version = '${{ inputs.version }}';
          const baseDir = 'packages/spitestack-cli/npm';
          const dirs = fs.readdirSync(baseDir).filter((d) => !d.startsWith('.'));
          const paths = [
            'packages/spitestack-cli/package.json',
            ...dirs.map((d) => `${baseDir}/${d}/package.json`),
          ];

          for (const p of paths) {
            const data = JSON.parse(fs.readFileSync(p, 'utf8'));
            data.version = version;
            if (data.optionalDependencies) {
              for (const k of Object.keys(data.optionalDependencies)) {
                data.optionalDependencies[k] = version;
              }
            }
            fs.writeFileSync(p, JSON.stringify(data, null, 2) + '\n');
          }
          NODE

      - name: Publish wrapper
        shell: bash
        run: |
          cd packages/spitestack-cli
          npm publish --access public --tag "${{ inputs.tag }}" --provenance
